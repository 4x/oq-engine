# -*- coding: utf-8 -*-
# vim: tabstop=4 shiftwidth=4 softtabstop=4

import os
import unittest

from opengem.parser import parser_vulnerability_model

TEST_FILE = 'VulnerabilityModelFile-test.xml'

data_dir = os.path.join(os.path.dirname(__file__), 'data')

class VulnerabilityModelFileTestCase(unittest.TestCase):
	
    def test_filter_attribute_constraint(self):
        """ This test uses the attribute constraint filter to select items
        from the input file. We assume here that the parser yields the
        items in the same order as specified in the example XML file. In
        a general case it would be better not to assume the order of 
        yielded items to be known, but to locate each yielded result
        item in a set of expected results.
        """

        test_attribute_dicts = [
            {'ID': 'IR'},
            {'IntensityMeasureType': 'MMI'},
            {'ProbabilisticDistribution': 'LN'}
        ]

        expected_results = [ [{'ID': 'IR',
		                        'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
	                            {'ID': 'PK',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'VE',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'MA',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'GT',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'CN',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'IN',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'TR',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'AF',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'EC',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'JP',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'PH',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'ID',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'IT',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'TW',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'CR',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'MX',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'DZ',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'RO',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'PT',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'CL',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'GE',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'GR',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'CO',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'PE',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'SV',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'XF',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'NZ',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
								{'ID': 'G01',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'},
	                            {'ID': 'G02',
	                            'IntensityMeasureType': 'MMI',
	                            'ProbabilisticDistribution': 'LN'}]
	                       ]

        # set a region constraint that inlcudes all points 
        region_constraint = region.RegionConstraint.from_simple((-20.0, 80.0),
                                                                (40.0, 0.0))
        for attr_test_counter, curr_attribute_dict in enumerate(
            test_attribute_dicts):
            attribute_constraint = \
                parser_vulnerability_model.VulnerabilityModelConstraint(curr_attribute_dict)

            vulnerability = parser_vulnerability_model.VulnerabilityModelFile(os.path.join(data_dir, 
                                                              TEST_FILE))

            counter = None
            for counter, (vulnerability_point, vulnerability_attr) in enumerate(
                vulnerability.filter(attribute_constraint = attribute_constraint)):

				self.assertEqual(vulnerability_attr, expected_results[
                    attr_test_counter][counter][1],
                    "filter yielded unexpected attribute values at position" \
                    " %s: %s, %s" % (counter, vulnerability_attr, 
                        expected_results[attr_test_counter][counter][1]))

            # ensure that generator yielded at least one item
            self.assertTrue(counter is not None, 
                "filter yielded nothing although %s item(s) were expected" % \
                len(expected_results[attr_test_counter]))

            # ensure that generator returns exactly the number of items of the
            # expected result list
            self.assertEqual(counter, 
                len(expected_results[attr_test_counter])-1,
                "filter yielded wrong number of items (%s), expected were %s" \
                % (counter+1, len(expected_results[attr_test_counter])))